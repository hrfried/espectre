# üõú ESPectre üëª - Tuning Guide

Quick guide to tune ESPectre for reliable movement detection in your environment.

---

## üöÄ Quick Start (5 minutes)

> **üìå Note on Subcarrier Selection**: ESPectre automatically selects optimal subcarriers using the NBVI (Normalized Baseline Variability Index) algorithm at first boot. No manual configuration needed.

### 1. Flash and Boot

After flashing your device with ESPHome:

```bash
# View logs to monitor calibration
esphome logs espectre.yaml
```

### 2. Wait for NBVI Calibration

On first boot, keep the room **empty and still** for 5-10 seconds. The system will:
1. Collect 500 CSI packets
2. Analyze subcarrier characteristics
3. Select optimal 12 subcarriers
4. Save configuration (persists across reboots)

Look for log messages like:
```
[I][espectre:xxx]: NBVI calibration complete, selected 12 subcarriers
```

### 3. Test Movement

Walk around the room while monitoring logs:

```bash
esphome logs espectre.yaml
```

Look for state changes:
- `state=MOTION` when moving
- `state=IDLE` when still

### 4. Adjust Threshold if Needed

If detection isn't working well, modify `segmentation_threshold` in your YAML:

```yaml
espectre:
  segmentation_threshold: 1.0  # Default
```

**Rule of thumb:**
- Too many false positives ‚Üí increase threshold (try 2.0-5.0)
- Missing movements ‚Üí decrease threshold (try 0.5-0.8)

After changing, re-flash:
```bash
esphome run espectre.yaml
```

---

## üéØ Understanding Parameters

### Segmentation Threshold (0.5-10.0)

**What it does:** Determines sensitivity for motion detection.

**Default:** 1.0

| Value | Sensitivity | Use Case |
|-------|-------------|----------|
| 0.5-1.0 | High | Detect subtle movements, quiet environments |
| 1.0-3.0 | Medium | General purpose, most environments |
| 3.0-5.0 | Low | Noisy environments, reduce false positives |
| 5.0-10.0 | Very Low | Only detect significant movements |

**Configuration:**
```yaml
espectre:
  segmentation_threshold: 1.0
```

### Window Size (10-200 packets)

**What it does:** Number of turbulence samples used to calculate moving variance.

**Default:** 50 packets

| Value | Response | Stability | Use Case |
|-------|----------|-----------|----------|
| 10-30 | Fast | Noisy | Quick response needed |
| 50-100 | Balanced | Good | **Recommended** |
| 100-200 | Slow | Very stable | Reduce flickering |

**Configuration:**
```yaml
espectre:
  segmentation_window_size: 50
```

<details>
<summary><b>üìä Optimal Window Configuration Guide</b></summary>

To detect general movement (walking, arm movement, standing up), you need to balance **sensitivity** (capturing even minimal movements) and **robustness** (ignoring noise).

**Sampling Rate ($F_s$)**

Maintaining $F_s = 100 \text{ Hz}$ is an excellent compromise between accuracy and computational load for detecting most human activities.

**Moving Window Size ($N$)**

For general movement detection, a window is recommended that captures transient action while being long enough to dampen high-frequency noise.

| $T_{window}$ | $N$ (at 100 Hz) | Advantage for Presence Detection |
|--------------|-----------------|----------------------------------|
| $0.5$ seconds | $50$ packets | Extremely reactive, but too sensitive to noise. |
| $1$ second | $100$ packets | **Recommended**. Optimal balance, captures $1-2$ steps or a complete gesture. |
| $2$ seconds | $200$ packets | Slower to react, but very robust against false positives. |

**Recommendation:** Start with $N=50$ packets (corresponding to $0.5$ seconds). This is a good starting point for detecting activities like entering a room.

</details>

### Traffic Generator Rate (0-1000 pps)

**What it does:** Controls how many packets per second are sent for CSI measurement.

**Default:** 100 pps

| Rate | Use Case |
|------|----------|
| 50 pps | Basic presence detection, minimal overhead |
| 100 pps | **Recommended** - Activity recognition |
| 600-1000 pps | Fast motion detection, precision localization |
| 0 pps | Disabled (only if you have other continuous WiFi traffic) |

**Configuration:**
```yaml
espectre:
  traffic_generator_rate: 100
```

<details>
<summary><b>üìê Understanding Sampling Rates (Nyquist-Shannon Theorem)</b></summary>

The traffic generator rate determines the maximum frequency of motion that can be accurately detected. According to the **Nyquist-Shannon Sampling Theorem**, the sampling rate (Fs) must be at least twice the maximum frequency of the signal (Fmax):

$$F_s \geq 2 \times F_{max}$$

In Wi-Fi sensing, Fmax is the highest Doppler frequency generated by human movement reflected in the CSI signal.

**Application Scenarios:**

| Activity Type | Max Frequency (Fmax) | Minimum Sampling Rate (Fs) | Recommended Rate |
|---------------|---------------------|---------------------------|------------------|
| **Vital signs** (breathing, heartbeat) | < 5 Hz | ‚â• 10 Hz | 10-30 pps |
| **Activity recognition** (walking, sitting, gestures) | ‚âà 10-30 Hz | ‚â• 60 Hz | 60-100 pps |
| **Fast motion** (rapid gestures, precision localization) | ‚âà 300-400 Hz | ‚â• 600 Hz | 600-1000 pps |

**Key Takeaways:**
- Higher rates enable detection of faster movements
- Lower rates are sufficient for slow movements (vital signs, presence)
- Choose the rate based on your application requirements
- Higher rates increase CPU usage and network traffic

</details>

---

## ‚öôÔ∏è Optional Parameters

### Feature Extraction

**What it does:** Enables detailed feature analysis (10 mathematical features from CSI data).

**Default:** Disabled

**When to enable:**
- You want to analyze CSI features in Home Assistant
- Building ML models for activity recognition
- Debugging or research purposes

**Configuration:**
```yaml
espectre:
  features_enabled: true

sensor:
  - platform: espectre
    variance:
      name: "CSI Variance"
    entropy:
      name: "CSI Entropy"
    # ... other feature sensors
```

---

## üîß Optional Filters

**Note:** Filters are applied only to feature extraction, not to motion detection (segmentation).

### Butterworth Low-Pass Filter

**What it does:** Removes high-frequency noise (>8Hz) from features.

**Default:** Disabled

**When to enable:** High interference environments.

**Configuration:**
```yaml
espectre:
  butterworth_enabled: true
```

### Hampel Filter (Outlier Removal)

**What it does:** Removes statistical outliers from features using MAD (Median Absolute Deviation).

**Default:** Disabled

**When to enable:** High interference environments (fans, AC, microwave).

**Configuration:**
```yaml
espectre:
  hampel_enabled: true
  hampel_threshold: 2.0  # 1.0-10.0, lower = more aggressive
```

### Savitzky-Golay Filter

**What it does:** Smooths feature values using polynomial fitting.

**Default:** Disabled

**Configuration:**
```yaml
espectre:
  savgol_enabled: true
```

### Wavelet Filter (Advanced)

**What it does:** Removes persistent low-frequency noise using Daubechies wavelet transform.

**Default:** Disabled

**When to enable:** Very high noise environments where other filters aren't enough.

**Configuration:**
```yaml
espectre:
  wavelet_enabled: true
  wavelet_level: 3        # 1-3, higher = more denoising
  wavelet_threshold: 1.0  # 0.5-2.0
```

**Performance impact:** ~5-8% CPU load, 320ms warm-up time.

---

## üîç Troubleshooting

### Too Many False Positives

**Symptoms:** Detects motion when room is empty.

**Solutions:**

1. **Increase threshold:**
   ```yaml
   espectre:
     segmentation_threshold: 3.0  # Try 2.0-5.0
   ```

2. **Increase window size:**
   ```yaml
   espectre:
     segmentation_window_size: 100  # Try 100-150
   ```

3. **Check for interference sources** (fans, AC, moving curtains)

4. **Re-flash and test:**
   ```bash
   esphome run espectre.yaml
   ```

### Missing Movements

**Symptoms:** Doesn't detect when people move.

**Solutions:**

1. **Decrease threshold:**
   ```yaml
   espectre:
     segmentation_threshold: 0.5  # Try 0.5-0.8
   ```

2. **Check sensor position** (optimal: 3-8m from router)

3. **Verify traffic generator is active:**
   ```yaml
   espectre:
     traffic_generator_rate: 100  # Must be > 0
   ```

4. **Check logs for CSI packets:**
   ```bash
   esphome logs espectre.yaml
   ```

### Unstable Detection

**Symptoms:** Rapid flickering between IDLE and MOTION.

**Solutions:**

1. **Increase threshold:**
   ```yaml
   espectre:
     segmentation_threshold: 2.0
   ```

2. **Increase window size:**
   ```yaml
   espectre:
     segmentation_window_size: 100
   ```

### Reset Calibration

**When needed:** Start fresh with new subcarrier selection.

**How to reset:**

1. Erase flash completely:
   ```bash
   esphome run espectre.yaml --device /dev/ttyUSB0
   # Choose "Erase flash before uploading" if available
   ```

2. Or use ESPHome dashboard: **Clean Build Files** then re-install

**After reset:**
- Keep room quiet for 5-10 seconds
- NBVI will automatically recalibrate
- Check logs for calibration completion

---

## üìä Monitoring

### View Real-Time Logs

```bash
# Via USB
esphome logs espectre.yaml

# Via network (after first flash)
esphome logs espectre.yaml --device espectre.local
```

### Home Assistant

After integration, monitor sensors in Home Assistant:
- **binary_sensor.espectre_motion_detected** - Motion state
- **sensor.espectre_movement_score** - Movement intensity
- **sensor.espectre_detection_threshold** - Current threshold

Use **History** graphs to visualize detection patterns over time.

---

## üéì Quick Tips

1. **Start simple:** Tune only the segmentation threshold first
2. **One change at a time:** Adjust one parameter, re-flash, test for 5-10 minutes
3. **Document your settings:** Note what works for your environment
4. **Seasonal adjustments:** Retune when furniture changes or new interference sources appear
5. **Distance matters:** Keep sensor 3-8m from router for optimal performance
6. **Quiet calibration:** Ensure no movement during first 5-10 seconds after boot

---

## üìö Additional Resources

- **Main Documentation:** [README.md](README.md)
- **Setup Guide:** [SETUP.md](SETUP.md)
- **GitHub Issues:** [Report problems](https://github.com/francescopace/espectre/issues)
- **Email:** francesco.pace@gmail.com
