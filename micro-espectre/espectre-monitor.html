<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPectre Real-Time Monitor</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt@5.3.0/dist/mqtt.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card.compact {
            padding: 12px 20px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        .collapsible-content {
            margin-top: 15px;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9em;
        }

        .input-group input {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-sm {
            padding: 6px 15px;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        .status-indicator.disconnected {
            background: #e74c3c;
            animation: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .metric-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-3px);
        }

        .metric-card.idle {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .metric-card.motion {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .metric-card.neutral {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 600px;
            margin-bottom: 10px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 1.3em;
            margin: 0;
        }

        .arrow {
            transition: transform 0.3s;
            font-size: 0.9em;
        }

        .arrow.rotate {
            transform: rotate(180deg);
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: #2ecc71;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 400px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #667eea;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-reload {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: #667eea;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-reload:hover {
            background: #667eea15;
            transform: scale(1.1);
        }

        .modal-reload.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            font-family: monospace;
            font-size: 0.95em;
            line-height: 1.6;
            color: #333;
        }

        .stat-section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e8e8e8;
        }

        .stat-section:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .stat-section-title {
            font-size: 0.85em;
            font-weight: 600;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-line {
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .stat-line:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #666;
            font-size: 1em;
            flex-shrink: 0;
        }

        .stat-value {
            color: #333;
            font-weight: 600;
            font-size: 1em;
            text-align: right;
            word-break: break-word;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        .stat-value.success {
            color: #2ecc71;
        }

        .stat-value.warning {
            color: #f39c12;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üõú ESPectre üëª</h1>
            <p>Real-Time Motion Detection Visualization</p>
        </div>

        <!-- MQTT Configuration Card -->
        <div class="card compact">
            <div class="collapsible-header" onclick="toggleConfig()" style="display: flex; align-items: center; gap: 15px;">
                <h2 style="margin: 0;">‚öôÔ∏è MQTT Configuration</h2>
                <div class="status-item" style="margin-left: auto;">
                    <div class="status-indicator disconnected" id="statusIndicator"></div>
                    <span id="statusText">Disconnected</span>
                </div>
                <span class="arrow" id="configArrow">‚ñº</span>
            </div>
            <div class="collapsible-content" id="configContent">
                <div class="config-section">
                    <div class="input-group">
                        <label for="broker">Broker Address</label>
                        <input type="text" id="broker" placeholder="homeassistant.local" value="homeassistant.local">
                    </div>
                    <div class="input-group">
                        <label for="port">WebSocket Port</label>
                        <input type="number" id="port" placeholder="9001" value="9001">
                    </div>
                    <div class="input-group">
                        <label for="topic">Topic</label>
                        <input type="text" id="topic" placeholder="home/espectre/node1" value="home/espectre/node1">
                    </div>
                    <div class="input-group">
                        <label for="username">Username (optional)</label>
                        <input type="text" id="username" placeholder="user" value="mqtt">
                    </div>
                    <div class="input-group">
                        <label for="password">Password (optional)</label>
                        <input type="password" id="password" placeholder="password" value="mqtt">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">Connect</button>
                    <button class="btn btn-danger" id="clearBtn" onclick="clearData()" style="display: none;">Clear Data</button>
                </div>
            </div>
        </div>

        <!-- ESPectre Configuration -->
        <div class="card">
            <div class="collapsible-header" onclick="toggleSection('configuration')">
                <h2>‚öôÔ∏è Device Configuration</h2>
                <span class="arrow rotate" id="configurationArrow">‚ñº</span>
            </div>
            <div class="collapsible-content collapsed" id="configurationContent">
                <!-- Device & Network Information -->
                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; font-size: 0.95em;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üñ•Ô∏è</span>
                            <span style="font-weight: 600; color: #666;">Model:</span>
                            <span id="deviceType" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üåê</span>
                            <span style="font-weight: 600; color: #666;">IP:</span>
                            <span id="deviceIP" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üè∑Ô∏è</span>
                            <span style="font-weight: 600; color: #666;">MAC:</span>
                            <span id="deviceMAC" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üõú</span>
                            <span style="font-weight: 600; color: #666;">Protocol:</span>
                            <span id="wifiProtocol" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üì∂</span>
                            <span style="font-weight: 600; color: #666;">Bandwidth:</span>
                            <span id="wifiBandwidth" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üìª</span>
                            <span style="font-weight: 600; color: #666;">Channel:</span>
                            <span id="wifiChannel" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">üî¢</span>
                            <span style="font-weight: 600; color: #666;">CSI:</span>
                            <span id="wifiCSI" style="font-family: monospace; color: #333; font-weight: 600;">-</span>
                        </div>
                    </div>
                </div>

                <!-- Detection Parameters Section -->
                <div
                    style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 2px solid #e0e0e0;">
                    <div class="collapsible-header" onclick="toggleSubSection('detectionParams')"
                        style="padding: 5px 0;">
                        <h3
                            style="margin: 0; color: #667eea; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <span>üéØ</span> Detection Parameters
                        </h3>
                        <span class="arrow" id="detectionParamsArrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="detectionParamsContent" style="margin-top: 15px;">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                            <div class="input-group">
                                <label for="windowSize" style="font-size: 0.85em;">‚ö° Response Speed (10-200)</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="range" id="windowSize" min="10" max="200" step="1" value="50"
                                        style="flex: 1;">
                                    <input type="number" id="windowSizeValue" min="10" max="200" step="1" value="50"
                                        style="width: 70px; padding: 6px; font-size: 0.9em;">
                                </div>
                                <small style="color: #666; font-size: 0.8em;">How fast the system reacts to changes.<br>Low value = quick response, more sensitive to noise.<br>High value = stable, filters out small variations.<br><b>Recommended: 50 üí°</b></small>
                            </div>
                            <div class="input-group">
                                <label for="segThreshold" style="font-size: 0.85em;">üéØ Motion Threshold (0.5-10.0)</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="range" id="segThreshold" min="0.5" max="10.0" step="0.1" value="1.0"
                                        style="flex: 1;">
                                    <input type="number" id="segThresholdValue" min="0.5" max="10.0" step="0.1"
                                        value="3.0" style="width: 70px; padding: 6px; font-size: 0.9em;">
                                </div>
                                <small style="color: #666; font-size: 0.8em;">Minimum threshold required to detect movement.<br>Low value = detects small movements.<br>High value = detects large movements.<br><b>Recommended: 1.0 for balanced detection üí°</b></small>
                            </div>
                            <div id="subcarrierSelectionContent" style="grid-column: span 2;">
                                <div class="input-group">
                                    <label style="font-size: 0.85em;">üìª Active Subcarriers</label>
                                    <div id="subcarrierIndices" 
                                        style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: monospace; width: 100%; background: #f5f5f5; color: #333;">-</div>
                                    <small style="color: #666; font-size: 0.8em;">WiFi frequency channels used for motion detection</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Action Buttons -->
                <div
                    style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                    <button class="btn btn-warning" onclick="requestInfo()">Reload Info</button>
                    <button class="btn btn-success btn-sm" onclick="requestStats()">Statistics</button>
                    <button class="btn btn-danger" onclick="factoryReset()">Factory Reset</button>
                </div>
            </div>
        </div>

        <!-- Metrics Cards (Fixed) -->
        <div class="card compact">
            <div class="metrics-grid">
                <div class="metric-card idle" id="stateCard">
                    <div class="metric-label">State</div>
                    <div class="metric-value" id="stateValue">-</div>
                </div>
                <div class="metric-card neutral" id="confidenceCard" style="display: none;">
                    <div class="metric-label">Confidence</div>
                    <div class="metric-value" id="confidenceValue">-</div>
                    <div style="margin-top: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; height: 6px; overflow: hidden;">
                        <div id="confidenceBar" style="height: 100%; background: white; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="metric-card neutral">
                    <div class="metric-label">Movement</div>
                    <div class="metric-value" id="movementValue">-</div>
                </div>
                <div class="metric-card neutral">
                    <div class="metric-label">Last Update</div>
                    <div class="metric-value" id="lastUpdate">-</div>
                </div>
            </div>
        </div>

        <!-- Chart  (Fixed) -->
        <div class="card">
            <div class="chart-header">
                <h2 class="chart-title" id="chartTitle">üìà Real-Time Chart</h2>
                <button class="btn btn-warning btn-sm" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
            </div>
            <div class="chart-container">
                <canvas id="motionChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        let client = null;
        let chart = null;
        let maxDataPoints = 60;
        let currentFeatures = null;
        let isPaused = false;
        let pendingData = [];

        const chartData = {
            labels: [],
            movement: [],
            threshold: [],
            features: [],
            confidence: [],
            triggered: [],
            pps: [],
            packets_dropped: []
        };

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('motionChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Movement',
                            data: chartData.movement,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Threshold',
                            data: chartData.threshold,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Packets/sec',
                            data: chartData.pps,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Dropped',
                            data: chartData.packets_dropped,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 300
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Movement / Threshold'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'CSI Packets'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterBody: function (context) {
                                    const index = context[0].dataIndex;
                                    const features = chartData.features[index];
                                    const confidence = chartData.confidence[index];
                                    const triggered = chartData.triggered[index];

                                    const lines = [''];

                                    // Show confidence and triggered features if available
                                    if (confidence !== null && confidence !== undefined) {
                                        lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                                        lines.push(`üéØ Confidence: ${(confidence * 100).toFixed(1)}%`);
                                        if (triggered && triggered.length > 0) {
                                            lines.push(`‚ö° Triggered: ${triggered.join(', ')}`);
                                        }
                                    }

                                    // Show features only if available (publish-time features)
                                    if (features) {
                                        lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                                        lines.push('üî¨ Extracted Features:');
                                        lines.push('');
                                        // Turbulence buffer features
                                        lines.push(`Entropy (turb): ${features.entropy_turb?.toFixed(3) || 'N/A'}`);
                                        lines.push(`IQR (turb): ${features.iqr_turb?.toFixed(3) || 'N/A'}`);
                                        lines.push(`Variance (turb): ${features.variance_turb?.toFixed(3) || 'N/A'}`);
                                        // W=1 features
                                        lines.push(`Skewness: ${features.skewness?.toFixed(3) || 'N/A'}`);
                                        lines.push(`Kurtosis: ${features.kurtosis?.toFixed(3) || 'N/A'}`);
                                    }

                                    return lines;
                                }
                            }
                        }
                    }
                }
            });
        }

        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            const chartTitle = document.getElementById('chartTitle');

            if (isPaused) {
                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                pauseBtn.classList.remove('btn-warning');
                pauseBtn.classList.add('btn-success');
                chartTitle.textContent = 'üìà Real-Time Chart (PAUSED)';
            } else {
                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                pauseBtn.classList.remove('btn-success');
                pauseBtn.classList.add('btn-warning');
                chartTitle.textContent = 'üìà Real-Time Chart';

                // Add all pending data when resuming
                if (pendingData.length > 0) {
                    pendingData.forEach(data => addDataToChart(data));
                    pendingData = [];
                }
            }
        }

        function toggleConfig() {
            const content = document.getElementById('configContent');
            const arrow = document.getElementById('configArrow');
            content.classList.toggle('collapsed');
            arrow.classList.toggle('rotate');
        }

        function toggleConnection() {
            if (client && client.connected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            const broker = document.getElementById('broker').value;
            const port = document.getElementById('port').value;
            const topic = document.getElementById('topic').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!broker || !port || !topic) {
                alert('Please fill in all required fields!');
                return;
            }

            const connectUrl = `ws://${broker}:${port}/mqtt`;

            const options = {
                clean: true,
                connectTimeout: 4000,
                clientId: 'espectre_monitor_' + Math.random().toString(16).substr(2, 8)
            };

            if (username) options.username = username;
            if (password) options.password = password;

            try {
                client = mqtt.connect(connectUrl, options);

                client.on('connect', () => {
                    console.log('Connected to MQTT broker');
                    updateStatus(true);
                    document.getElementById('configContent').classList.add('collapsed');
                    document.getElementById('configArrow').classList.add('rotate');

                    // Subscribe to main topic
                    client.subscribe(topic, (err) => {
                        if (err) {
                            console.error('Subscribe error:', err);
                            alert('Error subscribing to topic!');
                        } else {
                            console.log('Subscribed to:', topic);
                        }
                    });

                    // Also subscribe to response topic
                    const responseTopic = topic + '/response';
                    client.subscribe(responseTopic, (err) => {
                        if (err) {
                            console.error('Subscribe error for response topic:', err);
                        } else {
                            console.log('Subscribed to:', responseTopic);

                            // Request current configuration after successful connection
                            setTimeout(() => {
                                console.log('Requesting initial configuration...');
                                requestInfo();
                            }, 500); // Small delay to ensure subscriptions are ready
                        }
                    });
                });

                client.on('message', (topic, message) => {
                    // Text message - parse as JSON
                    handleMessage(message.toString());
                });

                client.on('error', (err) => {
                    console.error('Connection error:', err);
                    alert('Connection error: ' + err.message);
                    updateStatus(false);
                });

                client.on('close', () => {
                    console.log('Connection closed');
                    updateStatus(false);
                });

            } catch (err) {
                console.error('Connection error:', err);
                alert('Connection error: ' + err.message);
            }
        }

        function disconnect() {
            if (client) {
                client.end();
                client = null;
                updateStatus(false);
            }
        }

        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const clearBtn = document.getElementById('clearBtn');

            if (connected) {
                indicator.classList.remove('disconnected');
                indicator.classList.add('connected');
                statusText.textContent = 'Connected';
                connectBtn.textContent = 'Disconnect';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-danger');
                clearBtn.style.display = 'inline-block';
            } else {
                indicator.classList.remove('connected');
                indicator.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
                connectBtn.textContent = 'Connect';
                connectBtn.classList.remove('btn-danger');
                connectBtn.classList.add('btn-primary');
                clearBtn.style.display = 'none';
            }
        }


        function addDataToChart(data) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('en-US');
            
            // Use PPS calculated server-side (with ms precision)
            const pps = data.pps || 0;

            chartData.labels.push(timeLabel);
            chartData.movement.push(data.movement || 0);
            chartData.threshold.push(data.threshold || 0);
            chartData.features.push(data.features || null);
            chartData.confidence.push(data.confidence !== undefined ? data.confidence : null);
            chartData.triggered.push(data.triggered || null);
            chartData.pps.push(pps);
            chartData.packets_dropped.push(data.packets_dropped || 0);

            if (chartData.labels.length > maxDataPoints) {
                chartData.labels.shift();
                chartData.movement.shift();
                chartData.threshold.shift();
                chartData.features.shift();
                chartData.confidence.shift();
                chartData.triggered.shift();
                chartData.pps.shift();
                chartData.packets_dropped.shift();
            }

            chart.update('none');
        }

        function updateMetrics(data) {
            const stateCard = document.getElementById('stateCard');
            const stateValue = document.getElementById('stateValue');
            stateValue.textContent = data.state === 'motion' ? 'MOTION' : 'IDLE';

            if (data.state === 'motion') {
                stateCard.classList.remove('idle');
                stateCard.classList.add('motion');
            } else {
                stateCard.classList.remove('motion');
                stateCard.classList.add('idle');
            }

            document.getElementById('movementValue').textContent =
                data.movement ? data.movement.toFixed(2) : '-';

            // Update confidence if available
            const confidenceCard = document.getElementById('confidenceCard');
            const confidenceValue = document.getElementById('confidenceValue');
            const confidenceBar = document.getElementById('confidenceBar');
            
            if (data.confidence !== undefined && data.confidence !== null) {
                confidenceCard.style.display = 'block';
                const confPercent = (data.confidence * 100).toFixed(0);
                confidenceValue.textContent = confPercent + '%';
                confidenceBar.style.width = confPercent + '%';
                
                // Change color based on confidence level
                confidenceCard.classList.remove('idle', 'motion', 'neutral');
                if (data.confidence >= 0.7) {
                    confidenceCard.classList.add('motion');
                } else if (data.confidence >= 0.5) {
                    confidenceCard.classList.add('neutral');
                } else {
                    confidenceCard.classList.add('idle');
                }
            }
        }

        function clearData() {
            chartData.labels = [];
            chartData.movement = [];
            chartData.threshold = [];
            chartData.features = [];
            chartData.confidence = [];
            chartData.triggered = [];
            chartData.pps = [];
            chartData.packets_dropped = [];
            currentFeatures = null;
            pendingData = [];

            document.getElementById('lastUpdate').textContent = '-';
            document.getElementById('confidenceValue').textContent = '-';
            document.getElementById('confidenceBar').style.width = '0%';

            chart.update();
        }

        // MQTT Command Functions
        function sendCommand(cmd, params = {}) {
            if (!client || !client.connected) {
                showNotification('Not connected to MQTT broker', 'error');
                return;
            }

            const topic = document.getElementById('topic').value;
            const cmdTopic = topic + '/cmd';
            const message = JSON.stringify({ cmd, ...params });

            client.publish(cmdTopic, message, (err) => {
                if (err) {
                    showNotification(`Failed to send command: ${err.message}`, 'error');
                }
                // Removed "Command sent" notification for cleaner real-time updates
                // Only device responses will show notifications now
            });
        }


        // System Info Functions
        function requestInfo() {
            sendCommand('info');
        }

        function requestStats() {
            sendCommand('stats');
        }

        function factoryReset() {
            showFactoryResetModal();
        }

        function showFactoryResetModal() {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) closeModal();
            };

            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'modal-content';

            // Modal header
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.innerHTML = `
                <h3 style="color: #e74c3c;">‚ö†Ô∏è Factory Reset</h3>
            `;

            // Modal body
            const body = document.createElement('div');
            body.className = 'modal-body';
            body.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

            let html = '';
            html += `<div style="margin-bottom: 20px;">`;
            html += `<p style="font-size: 1em; color: #e74c3c; font-weight: 600; margin-bottom: 15px;">`;
            html += `This will reset ALL settings to factory defaults!`;
            html += `</p>`;
            html += `<p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">This includes:</p>`;
            html += `<ul style="margin-left: 20px; color: #666; font-size: 0.9em; line-height: 1.8;">`;
            html += `<li>Detection parameters</li>`;
            html += `<li>Filter settings</li>`;
            html += `<li>All saved configurations</li>`;
            html += `</ul>`;
            html += `</div>`;
            html += `<p style="font-size: 0.95em; color: #333; font-weight: 600; margin-top: 20px;">`;
            html += `Are you sure you want to continue?`;
            html += `</p>`;

            body.innerHTML = html;

            // Modal footer with buttons
            const footer = document.createElement('div');
            footer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;';
            footer.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()" style="padding: 10px 20px;">Cancel</button>
                <button class="btn btn-danger" onclick="confirmFactoryReset()" style="padding: 10px 20px;">Reset to Factory Defaults</button>
            `;

            modal.appendChild(header);
            modal.appendChild(body);
            modal.appendChild(footer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function confirmFactoryReset() {
            closeModal();
            sendCommand('factory_reset');
            showNotification('Factory reset command sent', 'info');
        }

        // Section Toggle Function
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const arrow = document.getElementById(sectionId + 'Arrow');
            content.classList.toggle('collapsed');
            arrow.classList.toggle('rotate');
        }

        // SubSection Toggle Function
        function toggleSubSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const arrow = document.getElementById(sectionId + 'Arrow');
            content.classList.toggle('collapsed');
            arrow.classList.toggle('rotate');
        }

        // Apply Detection Configuration Only
        function applyDetectionConfiguration() {
            const segThreshold = parseFloat(document.getElementById('segThresholdValue').value);
            const windowSize = parseInt(document.getElementById('windowSizeValue').value);
            // Send detection commands with delays
            let delay = 0;
            sendCommand('segmentation_threshold', { value: segThreshold });
            delay += 100;
            setTimeout(() => sendCommand('segmentation_window_size', { value: windowSize }), delay);

            showNotification('Detection configuration applied', 'success');
        }


        // Notification Function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Slider Synchronization
        function syncSlider(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const valueInput = document.getElementById(valueId);

            slider.addEventListener('input', (e) => {
                valueInput.value = e.target.value;
            });

            valueInput.addEventListener('input', (e) => {
                slider.value = e.target.value;
            });
        }

        // Enhanced Message Handler for Info/Stats and regular data
        function handleMessage(message) {
            try {
                const data = JSON.parse(message);

                // Log all messages to console for debugging
                console.log('Received message:', data);

                // Check if this is an info response (has network, mqtt, segmentation, filters, options)
                if (data.network || data.mqtt || (data.segmentation && data.filters && data.options)) {
                    console.log('Detected INFO response');
                    populateUIFromConfig(data);
                    return;
                }

                // Check if this is a stats response (has uptime, turbulence, packets_processed)
                if (data.uptime || (data.turbulence !== undefined && data.packets_processed !== undefined)) {
                    console.log('Detected STATS response');
                    displayStats(data);
                    return;
                }

                // Check if this is a simple response message (has "response" field)
                if (data.response && typeof data.response === 'string') {
                    console.log('Detected command response');
                    showNotification(data.response, 'info');
                    // Info is automatically published by device after factory_reset
                    return;
                }

                // Regular data message (has movement, threshold, state)
                if (data.movement !== undefined || data.threshold !== undefined || data.state) {
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('it-IT', { hour12: false });

                    currentFeatures = data.features || null;
                    
                    // Debug: log features if present
                    if (data.features) {
                        console.log('Features received:', data.features);
                        console.log('Confidence:', data.confidence);
                        console.log('Triggered:', data.triggered);
                    }

                    updateMetrics(data);

                    if (isPaused) {
                        pendingData.push(data);
                    } else {
                        addDataToChart(data);
                    }
                }

            } catch (err) {
                console.error('Error parsing message:', err);
            }
        }

        // Format uptime to human readable format
        function formatUptime(uptime) {
            if (!uptime) return 'N/A';

            // If uptime is already a formatted string, return it as is
            if (typeof uptime === 'string') {
                return uptime;
            }

            // If uptime is a number (seconds), format it
            if (typeof uptime === 'number') {
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const secs = uptime % 60;
                return `${hours}h ${minutes}m ${secs}s`;
            }

            return 'N/A';
        }

        // Format large numbers with thousands separator
        function formatNumber(num) {
            if (num === undefined || num === null) return 'N/A';
            return num.toLocaleString();
        }

        // Refresh stats in modal
        function refreshStats() {
            const reloadBtn = document.getElementById('statsReloadBtn');
            if (reloadBtn) {
                reloadBtn.classList.add('spinning');
                reloadBtn.disabled = true;
            }

            // Send stats command
            sendCommand('stats');

            // Re-enable button after a delay
            setTimeout(() => {
                if (reloadBtn) {
                    reloadBtn.classList.remove('spinning');
                    reloadBtn.disabled = false;
                }
            }, 1000);
        }

        // Display Stats in modal
        function displayStats(stats) {
            // Check if modal already exists
            let overlay = document.querySelector('.modal-overlay');
            let isUpdate = false;

            if (overlay) {
                // Modal exists, just update the content
                isUpdate = true;
            } else {
                // Create new modal overlay
                overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.onclick = (e) => {
                    if (e.target === overlay) closeModal();
                };
            }

            // Create or get modal content
            let modal = overlay.querySelector('.modal-content');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-content';
            } else {
                modal.innerHTML = ''; // Clear existing content
            }

            // Modal header with reload button
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.innerHTML = `
                <h3>Statistics</h3>
                <div class="modal-header-actions">
                    <button class="modal-reload" id="statsReloadBtn" onclick="refreshStats()" title="Refresh statistics">üîÑ</button>
                </div>
            `;

            // Modal body with organized sections
            const body = document.createElement('div');
            body.className = 'modal-body';

            // Determine state color
            const stateClass = stats.state === 'motion' ? 'warning' : 'success';
            const stateIcon = stats.state === 'motion' ? 'üî¥' : 'üü¢';

            let html = '';

            // System Status Section
            html += `<div class="stat-section">`;
            html += `<div class="stat-section-title">üìä System Status</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">‚è±Ô∏è Uptime</span>`;
            html += `<span class="stat-value">${formatUptime(stats.uptime)}</span>`;
            html += `</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">üß† Free Memory</span>`;
            html += `<span class="stat-value highlight">${stats.free_memory_kb !== undefined ? stats.free_memory_kb.toFixed(1) + ' KB' : 'N/A'}</span>`;
            html += `</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">‚ö° Loop Time</span>`;
            html += `<span class="stat-value highlight">${stats.loop_time_ms !== undefined ? stats.loop_time_ms.toFixed(2) + ' ms' : 'N/A'}</span>`;
            html += `</div>`;
            html += `</div>`;

            // Traffic Generator Section (if available)
            if (stats.traffic_generator) {
                const tg = stats.traffic_generator;
                const tgStatusClass = tg.running ? 'success' : 'warning';
                const tgStatusIcon = tg.running ? 'üü¢' : 'üî¥';
                const tgStatusText = tg.running ? 'Running' : 'Stopped';
                
                // Determine loop time health (target is ~10ms for 100pps)
                const loopTimeClass = tg.avg_loop_ms <= 12 ? 'success' : (tg.avg_loop_ms <= 20 ? 'warning' : 'danger');
                
                html += `<div class="stat-section">`;
                html += `<div class="stat-section-title">üì° Traffic Generator</div>`;
                html += `<div class="stat-line">`;
                html += `<span class="stat-label">${tgStatusIcon} Status</span>`;
                html += `<span class="stat-value ${tgStatusClass}">${tgStatusText}</span>`;
                html += `</div>`;
                html += `<div class="stat-line">`;
                html += `<span class="stat-label">üéØ Target Rate</span>`;
                html += `<span class="stat-value">${tg.target_pps || 0} pps</span>`;
                html += `</div>`;
                html += `<div class="stat-line">`;
                html += `<span class="stat-label">‚ö° Actual Rate</span>`;
                html += `<span class="stat-value highlight">${tg.actual_pps || 0} pps</span>`;
                html += `</div>`;
                html += `<div class="stat-line">`;
                html += `<span class="stat-label">‚è±Ô∏è Avg Loop Time</span>`;
                html += `<span class="stat-value ${loopTimeClass}">${tg.avg_loop_ms !== undefined ? tg.avg_loop_ms.toFixed(2) + ' ms' : 'N/A'}</span>`;
                html += `</div>`;
                html += `<div class="stat-line">`;
                html += `<span class="stat-label">üì¶ Packets Sent</span>`;
                html += `<span class="stat-value">${(tg.packets_sent || 0).toLocaleString()}</span>`;
                html += `</div>`;
                if (tg.errors > 0) {
                    html += `<div class="stat-line">`;
                    html += `<span class="stat-label">‚ö†Ô∏è Errors</span>`;
                    html += `<span class="stat-value warning">${tg.errors}</span>`;
                    html += `</div>`;
                }
                html += `</div>`;
            }

            // Detection Metrics Section
            html += `<div class="stat-section">`;
            html += `<div class="stat-section-title">üéØ Detection Metrics</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">${stateIcon} State</span>`;
            html += `<span class="stat-value ${stateClass}">${(stats.state || 'N/A').toUpperCase()}</span>`;
            html += `</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">üåä Turbulence</span>`;
            html += `<span class="stat-value highlight">${stats.turbulence?.toFixed(3) || 'N/A'}</span>`;
            html += `</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">üìà Movement</span>`;
            html += `<span class="stat-value highlight">${stats.movement?.toFixed(3) || 'N/A'}</span>`;
            html += `</div>`;
            html += `<div class="stat-line">`;
            html += `<span class="stat-label">üéöÔ∏è Threshold</span>`;
            html += `<span class="stat-value">${stats.threshold?.toFixed(3) || 'N/A'}</span>`;
            html += `</div>`;
            html += `</div>`;

            body.innerHTML = html;

            modal.appendChild(header);
            modal.appendChild(body);

            if (!isUpdate) {
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
            }
        }

        // Close modal
        function closeModal() {
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        // Populate UI controls from config data
        function populateUIFromConfig(config) {
            console.log('Populating UI from config:', config);

            // Update Device & Network Information
            if (config.device && config.device.type) {
                document.getElementById('deviceType').textContent = config.device.type;
            }
            
            if (config.network) {
                if (config.network.ip_address) {
                    document.getElementById('deviceIP').textContent = config.network.ip_address;
                }
                if (config.network.mac_address) {
                    document.getElementById('deviceMAC').textContent = config.network.mac_address;
                }
                if (config.network.channel) {
                    const primary = config.network.channel.primary || '-';
                    const secondary = config.network.channel.secondary || 0;
                    const channelText = secondary > 0 ? `${primary} + ${secondary}` : `${primary}`;
                    document.getElementById('wifiChannel').textContent = channelText;
                }
                if (config.network.bandwidth) {
                    document.getElementById('wifiBandwidth').textContent = config.network.bandwidth;
                }
                if (config.network.protocol) {
                    document.getElementById('wifiProtocol').textContent = config.network.protocol;
                }
                if (config.network.csi_enabled !== undefined) {
                    document.getElementById('wifiCSI').textContent = config.network.csi_enabled ? 'Enabled' : 'Disabled';
                }
            }

            // Subcarrier selection (read-only display)
            if (config.subcarriers) {
                if (config.subcarriers.indices && Array.isArray(config.subcarriers.indices)) {
                    const indicesStr = config.subcarriers.indices.join(', ');
                    document.getElementById('subcarrierIndices').textContent = indicesStr;
                }
            }

            // Detection Parameters
            if (config.segmentation) {
                if (config.segmentation.threshold !== undefined) {
                    const threshold = config.segmentation.threshold;
                    document.getElementById('segThreshold').value = threshold;
                    document.getElementById('segThresholdValue').value = threshold;
                }
                if (config.segmentation.window_size !== undefined) {
                    const windowSize = config.segmentation.window_size;
                    document.getElementById('windowSize').value = windowSize;
                    document.getElementById('windowSizeValue').value = windowSize;
                }
            }

            showNotification('Configuration loaded from device', 'success');
        }

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Real-time configuration update functions with debounce
        const debouncedSendCommand = debounce((cmd, params) => {
            sendCommand(cmd, params);
        }, 300);

        // Setup real-time listeners for Detection Parameters
        function setupDetectionListeners() {
            // Segmentation Threshold
            document.getElementById('segThreshold').addEventListener('change', (e) => {
                debouncedSendCommand('segmentation_threshold', { value: parseFloat(e.target.value) });
            });
            document.getElementById('segThresholdValue').addEventListener('change', (e) => {
                debouncedSendCommand('segmentation_threshold', { value: parseFloat(e.target.value) });
            });

            // Window Size
            document.getElementById('windowSize').addEventListener('change', (e) => {
                debouncedSendCommand('segmentation_window_size', { value: parseInt(e.target.value) });
            });
            document.getElementById('windowSizeValue').addEventListener('change', (e) => {
                debouncedSendCommand('segmentation_window_size', { value: parseInt(e.target.value) });
            });

        }

        // Initialize on load
        window.addEventListener('load', () => {
            initChart();

            // Sync all sliders with their value inputs
            syncSlider('segThreshold', 'segThresholdValue');
            syncSlider('windowSize', 'windowSizeValue');

            // Setup real-time configuration listeners
            setupDetectionListeners();
        });
    </script>
</body>

</html>

